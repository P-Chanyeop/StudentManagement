<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수강권 관리 - K-PLAY 학원</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .enrollment-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .enrollment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,.2);
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.35rem 0.65rem;
        }
        .search-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .count-display {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .progress-bar-wrapper {
            height: 25px;
            border-radius: 10px;
        }
        .alert-item {
            border-left: 4px solid;
            padding-left: 1rem;
        }
        .alert-warning-border {
            border-color: #ffc107;
        }
        .alert-danger-border {
            border-color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-mortarboard-fill me-2"></i>K-PLAY 학원
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="students.html">학생관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="enrollments.html">수강권관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="attendance.html">출석체크</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> 로그아웃
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-ticket-perforated text-primary"></i> 수강권 관리</h2>
                <p class="text-muted">수강권 발급, 연장, 횟수 조절</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#addEnrollmentModal">
                    <i class="bi bi-plus-circle"></i> 수강권 발급
                </button>
                <button class="btn btn-outline-primary btn-lg" onclick="loadAlerts()">
                    <i class="bi bi-bell"></i> 알림 확인
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-0" id="totalEnrollments">0</h3>
                        <p class="text-muted mb-0">전체 수강권</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-0" id="activeEnrollments">0</h3>
                        <p class="text-muted mb-0">활성 수강권</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-0" id="expiringCount">0</h3>
                        <p class="text-muted mb-0">만료 임박 (7일)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <h3 class="text-danger mb-0" id="lowCountCount">0</h3>
                        <p class="text-muted mb-0">횟수 부족 (3회)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Filter Section -->
        <div class="search-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">검색</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="학생 이름 또는 과정명 검색...">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">상태</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">전체</option>
                        <option value="active">활성</option>
                        <option value="inactive">비활성</option>
                        <option value="expiring">만료임박</option>
                        <option value="low-count">횟수부족</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">정렬</label>
                    <select id="sortBy" class="form-select">
                        <option value="recent">최근등록순</option>
                        <option value="endDate">종료일순</option>
                        <option value="remaining">잔여횟수순</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">&nbsp;</label>
                    <button class="btn btn-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise"></i> 초기화
                    </button>
                </div>
            </div>
        </div>

        <!-- Enrollments Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>학생명</th>
                                <th>과정명</th>
                                <th>시작일</th>
                                <th>종료일</th>
                                <th>진행률</th>
                                <th>총횟수</th>
                                <th>사용</th>
                                <th>잔여</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="enrollmentsTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">수강권이 없습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Enrollment Modal -->
    <div class="modal fade" id="addEnrollmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-ticket-perforated"></i> 수강권 발급</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEnrollmentForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">학생 선택 <span class="text-danger">*</span></label>
                                <select class="form-select" id="studentId" required>
                                    <option value="">선택하세요</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">과정 선택 <span class="text-danger">*</span></label>
                                <select class="form-select" id="courseId" required>
                                    <option value="">선택하세요</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">시작일 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">종료일 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">총 횟수 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="totalCount" min="1" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-bold">메모</label>
                                <textarea class="form-control" id="memo" rows="3" placeholder="특이사항, 할인 내역 등"></textarea>
                            </div>
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="considerHolidays">
                                    <label class="form-check-label" for="considerHolidays">
                                        공휴일 제외하여 수강권 생성
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="addEnrollment()">
                        <i class="bi bi-check-circle"></i> 발급
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enrollment Detail Modal -->
    <div class="modal fade" id="enrollmentDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> 수강권 상세</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="enrollmentDetailContent">
                        <!-- Will be populated dynamically -->
                    </div>

                    <hr class="my-4">

                    <div class="row g-2">
                        <div class="col-md-6">
                            <button class="btn btn-warning w-100" onclick="showExtendModal()">
                                <i class="bi bi-calendar-plus"></i> 기간 연장
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-success w-100" onclick="showAddCountModal()">
                                <i class="bi bi-plus-circle"></i> 횟수 추가
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-primary w-100" onclick="showManualAdjustModal()">
                                <i class="bi bi-sliders"></i> 수동 조절
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-danger w-100" onclick="deactivateEnrollment()">
                                <i class="bi bi-x-circle"></i> 비활성화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extend Period Modal -->
    <div class="modal fade" id="extendModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> 기간 연장</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">현재 종료일</label>
                        <p id="currentEndDate" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">새 종료일 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="newEndDate" required>
                    </div>
                    <p class="text-muted small">또는</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">영업일 기준 연장</label>
                        <input type="number" class="form-control" id="businessDays" min="1" placeholder="공휴일 제외 일수">
                        <small class="text-muted">공휴일을 제외한 일수만큼 자동 연장됩니다.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" onclick="extendPeriod()">
                        <i class="bi bi-check-circle"></i> 연장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Count Modal -->
    <div class="modal fade" id="addCountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 횟수 추가</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">현재 잔여 횟수</label>
                        <p id="currentRemaining" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">추가할 횟수 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="additionalCount" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="addCount()">
                        <i class="bi bi-check-circle"></i> 추가
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Adjust Modal -->
    <div class="modal fade" id="manualAdjustModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-sliders"></i> 수동 횟수 조절</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>결석/보강 관리</strong><br>
                        양수(+): 횟수 증가 (보강, 연기)<br>
                        음수(-): 횟수 감소 (결석 처리)
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">현재 잔여 횟수</label>
                        <p id="currentRemainingAdjust" class="form-control-plaintext"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">조절할 횟수 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="adjustment" placeholder="예: +2 또는 -1" required>
                        <small class="text-muted">양수는 증가, 음수는 감소</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">사유 <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="reasonSelect" onchange="updateReasonInput()">
                            <option value="">직접 입력</option>
                            <option value="결석으로 인한 차감">결석으로 인한 차감</option>
                            <option value="보강으로 인한 복구">보강으로 인한 복구</option>
                            <option value="수업 연기">수업 연기</option>
                            <option value="관리자 조정">관리자 조정</option>
                        </select>
                        <input type="text" class="form-control" id="reason" placeholder="조절 사유를 입력하세요" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="manualAdjust()">
                        <i class="bi bi-check-circle"></i> 조절
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Modal -->
    <div class="modal fade" id="alertsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-bell"></i> 알림 현황</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="expiring-tab" data-bs-toggle="tab" data-bs-target="#expiring" type="button">
                                만료 임박 <span class="badge bg-warning" id="expiringBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="low-count-tab" data-bs-toggle="tab" data-bs-target="#low-count" type="button">
                                횟수 부족 <span class="badge bg-danger" id="lowCountBadge">0</span>
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="expiring" role="tabpanel">
                            <div id="expiringList"></div>
                        </div>
                        <div class="tab-pane fade" id="low-count" role="tabpanel">
                            <div id="lowCountList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let allEnrollments = [];
        let currentEnrollment = null;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Get auth headers
        function getAuthHeaders() {
            return {
                'Authorization': 'Bearer ' + localStorage.getItem('jwtToken'),
                'Content-Type': 'application/json'
            };
        }

        // Logout
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        }

        // Load enrollments
        async function loadEnrollments() {
            if (!checkAuth()) return;

            try {
                const response = await fetch(`${API_BASE_URL}/enrollments`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load enrollments');

                allEnrollments = await response.json();
                updateStatistics();
                applyFilters();
            } catch (error) {
                console.error('Error loading enrollments:', error);
                alert('수강권 정보를 불러오는데 실패했습니다.');
            }
        }

        // Update statistics
        function updateStatistics() {
            const total = allEnrollments.length;
            const active = allEnrollments.filter(e => e.isActive).length;

            $('#totalEnrollments').text(total);
            $('#activeEnrollments').text(active);

            // Load expiring and low count
            loadExpiringCount();
            loadLowCountCount();
        }

        // Load expiring count
        async function loadExpiringCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/expiring?days=7`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const data = await response.json();
                    $('#expiringCount').text(data.length);
                }
            } catch (error) {
                console.error('Error loading expiring count:', error);
            }
        }

        // Load low count
        async function loadLowCountCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/low-count?threshold=3`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const data = await response.json();
                    $('#lowCountCount').text(data.length);
                }
            } catch (error) {
                console.error('Error loading low count:', error);
            }
        }

        // Apply filters
        function applyFilters() {
            const searchText = $('#searchInput').val().toLowerCase();
            const statusFilter = $('#statusFilter').val();
            const sortBy = $('#sortBy').val();

            let filtered = allEnrollments.filter(enrollment => {
                const matchesSearch = !searchText ||
                    enrollment.studentName.toLowerCase().includes(searchText) ||
                    enrollment.courseName.toLowerCase().includes(searchText);

                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = enrollment.isActive;
                } else if (statusFilter === 'inactive') {
                    matchesStatus = !enrollment.isActive;
                } else if (statusFilter === 'expiring') {
                    const daysLeft = Math.ceil((new Date(enrollment.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                    matchesStatus = enrollment.isActive && daysLeft <= 7 && daysLeft >= 0;
                } else if (statusFilter === 'low-count') {
                    matchesStatus = enrollment.isActive && enrollment.remainingCount <= 3;
                }

                return matchesSearch && matchesStatus;
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'recent') {
                    return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                } else if (sortBy === 'endDate') {
                    return new Date(a.endDate) - new Date(b.endDate);
                } else if (sortBy === 'remaining') {
                    return a.remainingCount - b.remainingCount;
                }
                return 0;
            });

            displayEnrollments(filtered);
        }

        // Display enrollments
        function displayEnrollments(enrollments) {
            const tbody = $('#enrollmentsTableBody');
            tbody.empty();

            if (enrollments.length === 0) {
                $('#emptyState').show();
                return;
            }

            $('#emptyState').hide();

            enrollments.forEach(enrollment => {
                const progress = (enrollment.usedCount / enrollment.totalCount) * 100;
                const daysLeft = Math.ceil((new Date(enrollment.endDate) - new Date()) / (1000 * 60 * 60 * 24));

                let statusBadge = '';
                if (!enrollment.isActive) {
                    statusBadge = '<span class="badge bg-secondary">만료</span>';
                } else if (daysLeft < 0) {
                    statusBadge = '<span class="badge bg-danger">기간만료</span>';
                } else if (daysLeft <= 7) {
                    statusBadge = '<span class="badge bg-warning">임박</span>';
                } else if (enrollment.remainingCount <= 3) {
                    statusBadge = '<span class="badge bg-danger">횟수부족</span>';
                } else {
                    statusBadge = '<span class="badge bg-success">정상</span>';
                }

                const row = $(`
                    <tr onclick="viewEnrollmentDetail(${enrollment.id})" style="cursor: pointer;">
                        <td>${enrollment.id}</td>
                        <td><strong>${enrollment.studentName}</strong></td>
                        <td>${enrollment.courseName}</td>
                        <td>${enrollment.startDate}</td>
                        <td>${enrollment.endDate}</td>
                        <td>
                            <div class="progress progress-bar-wrapper">
                                <div class="progress-bar ${progress >= 90 ? 'bg-danger' : progress >= 70 ? 'bg-warning' : 'bg-success'}"
                                     style="width: ${progress}%">${progress.toFixed(0)}%</div>
                            </div>
                        </td>
                        <td>${enrollment.totalCount}</td>
                        <td>${enrollment.usedCount}</td>
                        <td><strong class="${enrollment.remainingCount <= 3 ? 'text-danger' : 'text-success'}">${enrollment.remainingCount}</strong></td>
                        <td>${statusBadge}</td>
                        <td onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewEnrollmentDetail(${enrollment.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });
        }

        // View enrollment detail
        async function viewEnrollmentDetail(enrollmentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/${enrollmentId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to load enrollment detail');

                currentEnrollment = await response.json();
                displayEnrollmentDetail(currentEnrollment);
                $('#enrollmentDetailModal').modal('show');
            } catch (error) {
                console.error('Error loading enrollment detail:', error);
                alert('수강권 정보를 불러오는데 실패했습니다.');
            }
        }

        // Display enrollment detail
        function displayEnrollmentDetail(enrollment) {
            const progress = (enrollment.usedCount / enrollment.totalCount) * 100;
            const daysLeft = Math.ceil((new Date(enrollment.endDate) - new Date()) / (1000 * 60 * 60 * 24));

            const html = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">학생명</label>
                        <p class="form-control-plaintext">${enrollment.studentName}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">과정명</label>
                        <p class="form-control-plaintext">${enrollment.courseName}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">시작일</label>
                        <p class="form-control-plaintext">${enrollment.startDate}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">종료일</label>
                        <p class="form-control-plaintext">${enrollment.endDate} <span class="badge ${daysLeft < 0 ? 'bg-danger' : daysLeft <= 7 ? 'bg-warning' : 'bg-info'}">${daysLeft}일 남음</span></p>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">진행률</label>
                        <div class="progress progress-bar-wrapper">
                            <div class="progress-bar ${progress >= 90 ? 'bg-danger' : progress >= 70 ? 'bg-warning' : 'bg-success'}"
                                 style="width: ${progress}%">${progress.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">총 횟수</label>
                        <p class="count-display text-primary">${enrollment.totalCount}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">사용 횟수</label>
                        <p class="count-display text-secondary">${enrollment.usedCount}</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">잔여 횟수</label>
                        <p class="count-display ${enrollment.remainingCount <= 3 ? 'text-danger' : 'text-success'}">${enrollment.remainingCount}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">활성 상태</label>
                        <p class="form-control-plaintext">
                            <span class="badge ${enrollment.isActive ? 'bg-success' : 'bg-secondary'}">
                                ${enrollment.isActive ? '활성' : '비활성'}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">메모</label>
                        <p class="form-control-plaintext">${enrollment.memo || '-'}</p>
                    </div>
                </div>
            `;
            $('#enrollmentDetailContent').html(html);
        }

        // Load students for dropdown
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE_URL}/students`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const students = await response.json();
                    const select = $('#studentId');
                    select.empty().append('<option value="">선택하세요</option>');
                    students.filter(s => s.isActive).forEach(student => {
                        select.append(`<option value="${student.id}">${student.name} (${student.grade || '학년미정'})</option>`);
                    });
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load courses for dropdown
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/courses`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const courses = await response.json();
                    const select = $('#courseId');
                    select.empty().append('<option value="">선택하세요</option>');
                    courses.filter(c => c.isActive).forEach(course => {
                        select.append(`<option value="${course.id}">${course.name} (₩${course.price.toLocaleString()})</option>`);
                    });
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Add enrollment
        async function addEnrollment() {
            const enrollmentData = {
                studentId: parseInt($('#studentId').val()),
                courseId: parseInt($('#courseId').val()),
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                totalCount: parseInt($('#totalCount').val()),
                memo: $('#memo').val() || null
            };

            if (!enrollmentData.studentId || !enrollmentData.courseId || !enrollmentData.startDate ||
                !enrollmentData.endDate || !enrollmentData.totalCount) {
                alert('필수 항목을 입력해주세요.');
                return;
            }

            try {
                const considerHolidays = $('#considerHolidays').is(':checked');
                const url = considerHolidays ? `${API_BASE_URL}/enrollments/with-holidays` : `${API_BASE_URL}/enrollments`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(enrollmentData)
                });

                if (!response.ok) throw new Error('Failed to add enrollment');

                alert('수강권이 발급되었습니다.');
                $('#addEnrollmentModal').modal('hide');
                $('#addEnrollmentForm')[0].reset();
                loadEnrollments();
            } catch (error) {
                console.error('Error adding enrollment:', error);
                alert('수강권 발급에 실패했습니다.');
            }
        }

        // Show extend modal
        function showExtendModal() {
            if (!currentEnrollment) return;
            $('#currentEndDate').text(currentEnrollment.endDate);
            $('#newEndDate').val('');
            $('#businessDays').val('');
            $('#enrollmentDetailModal').modal('hide');
            $('#extendModal').modal('show');
        }

        // Extend period
        async function extendPeriod() {
            if (!currentEnrollment) return;

            const newEndDate = $('#newEndDate').val();
            const businessDays = $('#businessDays').val();

            if (!newEndDate && !businessDays) {
                alert('새 종료일 또는 영업일을 입력해주세요.');
                return;
            }

            try {
                let url, params;
                if (businessDays) {
                    url = `${API_BASE_URL}/enrollments/${currentEnrollment.id}/extend-business-days?businessDays=${businessDays}`;
                } else {
                    url = `${API_BASE_URL}/enrollments/${currentEnrollment.id}/extend?newEndDate=${newEndDate}`;
                }

                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to extend period');

                alert('수강권 기간이 연장되었습니다.');
                $('#extendModal').modal('hide');
                loadEnrollments();
            } catch (error) {
                console.error('Error extending period:', error);
                alert('기간 연장에 실패했습니다.');
            }
        }

        // Show add count modal
        function showAddCountModal() {
            if (!currentEnrollment) return;
            $('#currentRemaining').text(currentEnrollment.remainingCount + '회');
            $('#additionalCount').val('');
            $('#enrollmentDetailModal').modal('hide');
            $('#addCountModal').modal('show');
        }

        // Add count
        async function addCount() {
            if (!currentEnrollment) return;

            const additionalCount = parseInt($('#additionalCount').val());
            if (!additionalCount || additionalCount <= 0) {
                alert('추가할 횟수를 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/${currentEnrollment.id}/add-count?additionalCount=${additionalCount}`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to add count');

                alert('횟수가 추가되었습니다.');
                $('#addCountModal').modal('hide');
                loadEnrollments();
            } catch (error) {
                console.error('Error adding count:', error);
                alert('횟수 추가에 실패했습니다.');
            }
        }

        // Show manual adjust modal
        function showManualAdjustModal() {
            if (!currentEnrollment) return;
            $('#currentRemainingAdjust').text(currentEnrollment.remainingCount + '회');
            $('#adjustment').val('');
            $('#reason').val('');
            $('#reasonSelect').val('');
            $('#enrollmentDetailModal').modal('hide');
            $('#manualAdjustModal').modal('show');
        }

        // Update reason input
        function updateReasonInput() {
            const selected = $('#reasonSelect').val();
            if (selected) {
                $('#reason').val(selected);
            }
        }

        // Manual adjust
        async function manualAdjust() {
            if (!currentEnrollment) return;

            const adjustment = parseInt($('#adjustment').val());
            const reason = $('#reason').val();

            if (!adjustment || adjustment === 0) {
                alert('조절할 횟수를 입력해주세요.');
                return;
            }

            if (!reason) {
                alert('조절 사유를 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/${currentEnrollment.id}/manual-adjust`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        adjustment: adjustment,
                        reason: reason
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to adjust count');
                }

                alert(`수강권 횟수가 ${adjustment > 0 ? '+' : ''}${adjustment}회 조절되었습니다.`);
                $('#manualAdjustModal').modal('hide');
                loadEnrollments();
            } catch (error) {
                console.error('Error adjusting count:', error);
                alert('횟수 조절에 실패했습니다: ' + error.message);
            }
        }

        // Deactivate enrollment
        async function deactivateEnrollment() {
            if (!currentEnrollment) return;

            if (!confirm('정말 이 수강권을 비활성화하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/${currentEnrollment.id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to deactivate enrollment');

                alert('수강권이 비활성화되었습니다.');
                $('#enrollmentDetailModal').modal('hide');
                loadEnrollments();
            } catch (error) {
                console.error('Error deactivating enrollment:', error);
                alert('비활성화에 실패했습니다.');
            }
        }

        // Load alerts
        async function loadAlerts() {
            try {
                const [expiringRes, lowCountRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/enrollments/expiring?days=7`, { headers: getAuthHeaders() }),
                    fetch(`${API_BASE_URL}/enrollments/low-count?threshold=3`, { headers: getAuthHeaders() })
                ]);

                const expiring = await expiringRes.json();
                const lowCount = await lowCountRes.json();

                $('#expiringBadge').text(expiring.length);
                $('#lowCountBadge').text(lowCount.length);

                displayAlertList(expiring, '#expiringList', 'warning');
                displayAlertList(lowCount, '#lowCountList', 'danger');

                $('#alertsModal').modal('show');
            } catch (error) {
                console.error('Error loading alerts:', error);
                alert('알림을 불러오는데 실패했습니다.');
            }
        }

        // Display alert list
        function displayAlertList(items, containerId, type) {
            const container = $(containerId);
            container.empty();

            if (items.length === 0) {
                container.html('<p class="text-muted">알림이 없습니다.</p>');
                return;
            }

            items.forEach(item => {
                const daysLeft = Math.ceil((new Date(item.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                const alertHtml = $(`
                    <div class="alert alert-${type} alert-item alert-${type}-border mb-2">
                        <strong>${item.studentName}</strong> - ${item.courseName}<br>
                        <small>종료일: ${item.endDate} (${daysLeft}일 남음) | 잔여: ${item.remainingCount}회</small>
                    </div>
                `);
                container.append(alertHtml);
            });
        }

        // Reset filters
        function resetFilters() {
            $('#searchInput').val('');
            $('#statusFilter').val('');
            $('#sortBy').val('recent');
            applyFilters();
        }

        // Event listeners
        $(document).ready(function() {
            checkAuth();
            loadEnrollments();
            loadStudents();
            loadCourses();

            $('#searchInput').on('keyup', applyFilters);
            $('#statusFilter').on('change', applyFilters);
            $('#sortBy').on('change', applyFilters);

            // Set default start date to today
            $('#startDate').val(new Date().toISOString().split('T')[0]);

            // Auto refresh every 5 minutes
            setInterval(loadEnrollments, 300000);
        });
    </script>
</body>
</html>
