<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수업 예약 - K-PLAY 학원</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
        }
        .time-slot {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-slot:hover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }
        .time-slot.available {
            border-color: #28a745;
            background: #d4edda;
        }
        .time-slot.full {
            border-color: #dc3545;
            background: #f8d7da;
            cursor: not-allowed;
        }
        .time-slot.reserved {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .day-selector {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .day-card {
            min-width: 100px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .day-card:hover {
            border-color: #0d6efd;
        }
        .day-card.active {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white;
        }
        .reservation-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        .reservation-card:hover {
            transform: translateX(5px);
        }
        .student-select-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .student-select-card:hover {
            border-color: #0d6efd;
        }
        .student-select-card.selected {
            border-color: #0d6efd;
            background: #e7f1ff;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-mortarboard-fill me-2"></i>K-PLAY 학원
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="reservations.html">수업예약</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mypage.html">마이페이지</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> 로그아웃
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-calendar-check text-primary"></i> 수업 예약</h2>
                <p class="text-muted">원하시는 시간대를 선택하여 수업을 예약하세요</p>
            </div>
        </div>

        <!-- Student Selection -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-person"></i> 예약할 학생 선택</h5>
            </div>
            <div class="card-body">
                <div id="studentSelection" class="row g-3">
                    <!-- Students will be loaded here -->
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Calendar Section -->
            <div class="col-lg-8">
                <div class="calendar-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 id="currentMonth"></h4>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="previousWeek()">
                                <i class="bi bi-chevron-left"></i> 이전
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="nextWeek()">
                                다음 <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Day Selector -->
                    <div class="day-selector" id="daySelector">
                        <!-- Days will be generated here -->
                    </div>

                    <!-- Time Slots -->
                    <div id="timeSlotsContainer">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 날짜를 선택하면 예약 가능한 시간대가 표시됩니다.
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Reservations -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> 내 예약 현황</h5>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div id="myReservations">
                            <!-- Reservations will be loaded here -->
                        </div>
                        <div id="noReservations" class="text-center py-5" style="display: none;">
                            <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">예약이 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Confirm Modal -->
    <div class="modal fade" id="reservationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> 예약 확인</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 아래 내용을 확인하고 예약을 완료하세요.
                    </div>
                    <div id="reservationConfirmDetails">
                        <!-- Details will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="confirmReservation()">
                        <i class="bi bi-check-circle"></i> 예약 완료
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let selectedStudent = null;
        let selectedDate = null;
        let selectedSlot = null;
        let currentWeekStart = new Date();
        let myStudents = [];
        let availableSlots = [];

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Get auth headers
        function getAuthHeaders() {
            return {
                'Authorization': 'Bearer ' + localStorage.getItem('jwtToken'),
                'Content-Type': 'application/json'
            };
        }

        // Logout
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        }

        // Load my students
        async function loadMyStudents() {
            if (!checkAuth()) return;

            try {
                // In a real scenario, this would fetch students associated with the logged-in parent
                // For now, we'll fetch all students
                const response = await fetch(`${API_BASE_URL}/students`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load students');

                myStudents = await response.json();
                displayStudentSelection();
            } catch (error) {
                console.error('Error loading students:', error);
                alert('학생 정보를 불러오는데 실패했습니다.');
            }
        }

        // Display student selection
        function displayStudentSelection() {
            const container = $('#studentSelection');
            container.empty();

            if (myStudents.length === 0) {
                container.html('<p class="text-muted">등록된 학생이 없습니다.</p>');
                return;
            }

            myStudents.forEach(student => {
                const card = $(`
                    <div class="col-md-6">
                        <div class="student-select-card ${selectedStudent && selectedStudent.id === student.id ? 'selected' : ''}"
                             onclick="selectStudent(${student.id})">
                            <h5>${student.name}</h5>
                            <p class="text-muted mb-0">
                                ${student.grade || '학년 미정'} | ${student.school || '학교 미등록'}
                            </p>
                        </div>
                    </div>
                `);
                container.append(card);
            });
        }

        // Select student
        function selectStudent(studentId) {
            selectedStudent = myStudents.find(s => s.id === studentId);
            displayStudentSelection();
            loadMyReservations();
        }

        // Initialize week
        function initWeek() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            currentWeekStart = new Date(today.setDate(diff));
            generateDaySelector();
        }

        // Previous week
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            generateDaySelector();
        }

        // Next week
        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            generateDaySelector();
        }

        // Generate day selector
        function generateDaySelector() {
            const container = $('#daySelector');
            container.empty();

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            $('#currentMonth').text(currentWeekStart.getFullYear() + '년 ' + monthNames[currentWeekStart.getMonth()]);

            const dayNames = ['월', '화', '수', '목', '금', '토', '일'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);

                const isPast = date < today;
                const isToday = date.getTime() === today.getTime();
                const isSelected = selectedDate && date.getTime() === selectedDate.getTime();

                const dayCard = $(`
                    <div class="day-card ${isSelected ? 'active' : ''} ${isPast ? 'disabled' : ''}"
                         onclick="${isPast ? '' : `selectDate(new Date(${date.getTime()}))`}"
                         style="${isPast ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <div class="fw-bold">${dayNames[i]}</div>
                        <div class="h4 mb-0">${date.getDate()}</div>
                        ${isToday ? '<small class="text-primary">오늘</small>' : ''}
                    </div>
                `);
                container.append(dayCard);
            }
        }

        // Select date
        function selectDate(date) {
            if (!selectedStudent) {
                alert('먼저 학생을 선택해주세요.');
                return;
            }

            selectedDate = date;
            generateDaySelector();
            loadTimeSlots();
        }

        // Load time slots
        async function loadTimeSlots() {
            if (!selectedDate || !selectedStudent) return;

            const dateStr = selectedDate.toISOString().split('T')[0];

            try {
                const response = await fetch(`${API_BASE_URL}/reservations/available?date=${dateStr}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    // If endpoint doesn't exist, show sample data
                    showSampleTimeSlots();
                    return;
                }

                availableSlots = await response.json();
                displayTimeSlots();
            } catch (error) {
                console.error('Error loading time slots:', error);
                showSampleTimeSlots();
            }
        }

        // Show sample time slots (for demo)
        function showSampleTimeSlots() {
            const container = $('#timeSlotsContainer');
            container.empty();

            container.append('<h5 class="mb-3">예약 가능한 시간</h5>');

            const timeSlots = [
                { time: '14:00 - 15:00', available: 5, max: 10, teacher: '김선생님' },
                { time: '15:00 - 16:00', available: 3, max: 10, teacher: '김선생님' },
                { time: '16:00 - 17:00', available: 0, max: 10, teacher: '이선생님' },
                { time: '17:00 - 18:00', available: 8, max: 10, teacher: '박선생님' },
                { time: '18:00 - 19:00', available: 6, max: 10, teacher: '최선생님' },
                { time: '19:00 - 20:00', available: 4, max: 10, teacher: '정선생님' }
            ];

            timeSlots.forEach((slot, index) => {
                const isFull = slot.available === 0;
                const slotDiv = $(`
                    <div class="time-slot ${isFull ? 'full' : 'available'}"
                         onclick="${isFull ? '' : `openReservationModal('${slot.time}', '${slot.teacher}')`}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${slot.time}</h5>
                                <small>${slot.teacher}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold ${isFull ? 'text-danger' : 'text-success'}">
                                    ${isFull ? '마감' : `${slot.available}/${slot.max} 자리`}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                container.append(slotDiv);
            });
        }

        // Display time slots
        function displayTimeSlots() {
            const container = $('#timeSlotsContainer');
            container.empty();

            if (availableSlots.length === 0) {
                container.html('<p class="text-muted">예약 가능한 시간이 없습니다.</p>');
                return;
            }

            container.append('<h5 class="mb-3">예약 가능한 시간</h5>');

            availableSlots.forEach(slot => {
                const isFull = slot.currentCount >= slot.maxCapacity;
                const slotDiv = $(`
                    <div class="time-slot ${isFull ? 'full' : 'available'}"
                         onclick="${isFull ? '' : `openReservationModal(${slot.id}, '${slot.startTime} - ${slot.endTime}')`}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${slot.startTime} - ${slot.endTime}</h5>
                                <small>${slot.teacherName || '담당선생님'}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold ${isFull ? 'text-danger' : 'text-success'}">
                                    ${isFull ? '마감' : `${slot.currentCount}/${slot.maxCapacity} 자리`}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                container.append(slotDiv);
            });
        }

        // Open reservation modal
        function openReservationModal(slotId, timeRange) {
            if (!selectedStudent) {
                alert('학생을 선택해주세요.');
                return;
            }

            selectedSlot = { id: slotId, time: timeRange };

            const dateStr = selectedDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            const html = `
                <table class="table">
                    <tr>
                        <th>학생</th>
                        <td>${selectedStudent.name}</td>
                    </tr>
                    <tr>
                        <th>날짜</th>
                        <td>${dateStr}</td>
                    </tr>
                    <tr>
                        <th>시간</th>
                        <td>${timeRange}</td>
                    </tr>
                </table>
            `;

            $('#reservationConfirmDetails').html(html);
            $('#reservationModal').modal('show');
        }

        // Confirm reservation
        async function confirmReservation() {
            if (!selectedStudent || !selectedDate || !selectedSlot) {
                alert('예약 정보가 올바르지 않습니다.');
                return;
            }

            const reservationData = {
                studentId: selectedStudent.id,
                date: selectedDate.toISOString().split('T')[0],
                timeSlot: selectedSlot.time,
                slotId: selectedSlot.id
            };

            try {
                const response = await fetch(`${API_BASE_URL}/reservations`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(reservationData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create reservation');
                }

                alert('예약이 완료되었습니다!');
                $('#reservationModal').modal('hide');
                loadTimeSlots();
                loadMyReservations();
            } catch (error) {
                console.error('Error creating reservation:', error);
                alert('예약에 실패했습니다: ' + error.message);
            }
        }

        // Load my reservations
        async function loadMyReservations() {
            if (!selectedStudent) {
                $('#myReservations').empty();
                $('#noReservations').show();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/reservations/student/${selectedStudent.id}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    // Show sample data if API doesn't exist
                    showSampleReservations();
                    return;
                }

                const reservations = await response.json();
                displayMyReservations(reservations);
            } catch (error) {
                console.error('Error loading reservations:', error);
                showSampleReservations();
            }
        }

        // Show sample reservations
        function showSampleReservations() {
            const container = $('#myReservations');
            container.empty();

            const sampleData = [
                {
                    id: 1,
                    date: '2024-01-15',
                    time: '15:00 - 16:00',
                    teacher: '김선생님',
                    status: 'CONFIRMED'
                },
                {
                    id: 2,
                    date: '2024-01-17',
                    time: '16:00 - 17:00',
                    teacher: '이선생님',
                    status: 'CONFIRMED'
                }
            ];

            if (sampleData.length === 0) {
                $('#noReservations').show();
                return;
            }

            $('#noReservations').hide();

            sampleData.forEach(reservation => {
                const card = $(`
                    <div class="card reservation-card">
                        <div class="card-body">
                            <h6 class="mb-2">${reservation.date}</h6>
                            <p class="mb-1"><i class="bi bi-clock"></i> ${reservation.time}</p>
                            <p class="mb-2"><i class="bi bi-person"></i> ${reservation.teacher}</p>
                            <span class="badge bg-success">${reservation.status === 'CONFIRMED' ? '확정' : '대기'}</span>
                            <button class="btn btn-sm btn-outline-danger float-end" onclick="cancelReservation(${reservation.id})">
                                취소
                            </button>
                        </div>
                    </div>
                `);
                container.append(card);
            });
        }

        // Display my reservations
        function displayMyReservations(reservations) {
            const container = $('#myReservations');
            container.empty();

            if (reservations.length === 0) {
                $('#noReservations').show();
                return;
            }

            $('#noReservations').hide();

            // Filter upcoming reservations
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcoming = reservations.filter(r => new Date(r.date) >= today);

            upcoming.forEach(reservation => {
                const statusBadge = reservation.status === 'CONFIRMED' ?
                    '<span class="badge bg-success">확정</span>' :
                    '<span class="badge bg-warning">대기</span>';

                const card = $(`
                    <div class="card reservation-card">
                        <div class="card-body">
                            <h6 class="mb-2">${reservation.date}</h6>
                            <p class="mb-1"><i class="bi bi-clock"></i> ${reservation.startTime} - ${reservation.endTime}</p>
                            <p class="mb-2"><i class="bi bi-person"></i> ${reservation.teacherName || '담당선생님'}</p>
                            ${statusBadge}
                            <button class="btn btn-sm btn-outline-danger float-end" onclick="cancelReservation(${reservation.id})">
                                취소
                            </button>
                        </div>
                    </div>
                `);
                container.append(card);
            });
        }

        // Cancel reservation
        async function cancelReservation(reservationId) {
            if (!confirm('예약을 취소하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/reservations/${reservationId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to cancel reservation');

                alert('예약이 취소되었습니다.');
                loadMyReservations();
                loadTimeSlots();
            } catch (error) {
                console.error('Error canceling reservation:', error);
                alert('예약 취소에 실패했습니다.');
            }
        }

        // Initialize
        $(document).ready(function() {
            checkAuth();
            initWeek();
            loadMyStudents();
        });
    </script>
</body>
</html>
