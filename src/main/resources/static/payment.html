<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청구서 결제 - K-PLAY 학원</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 포트원 JavaScript SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .container {
            max-width: 1200px;
        }
        .invoice-card {
            transition: transform 0.2s;
        }
        .invoice-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
        }
        .amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .login-section {
            max-width: 400px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 로그인 섹션 -->
        <div id="loginSection" class="login-section">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title text-center mb-4">청구서 결제 시스템</h3>
                    <div class="mb-3">
                        <label for="username" class="form-label">사용자명</label>
                        <input type="text" class="form-control" id="username" placeholder="사용자명 입력">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">비밀번호</label>
                        <input type="password" class="form-control" id="password" placeholder="비밀번호 입력">
                    </div>
                    <button class="btn btn-primary w-100" onclick="login()">로그인</button>
                    <div class="mt-3 text-muted small">
                        <p class="mb-1">테스트 계정:</p>
                        <p class="mb-0">아이디: admin / 비밀번호: admin123</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 섹션 -->
        <div id="mainSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>청구서 목록</h2>
                <button class="btn btn-secondary" onclick="logout()">로그아웃</button>
            </div>

            <!-- 필터 -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">상태</label>
                            <select class="form-select" id="statusFilter" onchange="loadInvoices()">
                                <option value="">전체</option>
                                <option value="PENDING">미납</option>
                                <option value="PAID">완납</option>
                                <option value="OVERDUE">연체</option>
                                <option value="CANCELLED">취소</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadInvoices()">조회</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 청구서 목록 -->
            <div id="invoiceList" class="row g-3">
                <!-- 동적으로 채워짐 -->
            </div>
        </div>
    </div>

    <!-- 결제 모달 -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">결제 정보 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">구매자명</label>
                        <input type="text" class="form-control" id="buyerName" placeholder="이름 입력">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">연락처</label>
                        <input type="text" class="form-control" id="buyerTel" placeholder="010-0000-0000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">이메일 (선택)</label>
                        <input type="email" class="form-control" id="buyerEmail" placeholder="email@example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">결제 수단</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="card">신용/체크카드</option>
                            <option value="trans">실시간 계좌이체</option>
                            <option value="vbank">가상계좌</option>
                            <option value="phone">휴대폰 소액결제</option>
                            <option value="kakaopay">카카오페이</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="requestPayment()">결제하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 전역 변수
        let authToken = '';
        let currentInvoice = null;
        let impCode = 'imp00000000'; // 포트원 가맹점 식별코드 (환경변수에서 가져와야 함)

        // 포트원 초기화
        const IMP = window.IMP;
        IMP.init(impCode);

        // 로그인
        function login() {
            const username = $('#username').val();
            const password = $('#password').val();

            if (!username || !password) {
                alert('사용자명과 비밀번호를 입력하세요.');
                return;
            }

            $.ajax({
                url: '/api/auth/login',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ username, password }),
                success: function(response) {
                    authToken = response.accessToken;
                    localStorage.setItem('authToken', authToken);
                    $('#loginSection').hide();
                    $('#mainSection').show();
                    loadInvoices();
                },
                error: function(xhr) {
                    alert('로그인 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                }
            });
        }

        // 로그아웃
        function logout() {
            authToken = '';
            localStorage.removeItem('authToken');
            $('#mainSection').hide();
            $('#loginSection').show();
            $('#username').val('');
            $('#password').val('');
        }

        // 청구서 목록 로드
        function loadInvoices() {
            const status = $('#statusFilter').val();
            let url = '/api/invoices';

            if (status) {
                url += '/status/' + status;
            }

            $.ajax({
                url: url,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                },
                success: function(invoices) {
                    displayInvoices(invoices);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        alert('인증이 만료되었습니다. 다시 로그인하세요.');
                        logout();
                    } else {
                        alert('청구서 조회 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                    }
                }
            });
        }

        // 청구서 목록 표시
        function displayInvoices(invoices) {
            const container = $('#invoiceList');
            container.empty();

            if (invoices.length === 0) {
                container.html('<div class="col-12"><div class="alert alert-info">청구서가 없습니다.</div></div>');
                return;
            }

            invoices.forEach(invoice => {
                const statusBadge = getStatusBadge(invoice.status);
                const canPay = invoice.status === 'PENDING' || invoice.status === 'OVERDUE';

                const card = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card invoice-card shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">${invoice.title}</h5>
                                    <span class="badge ${statusBadge.class} status-badge">${statusBadge.text}</span>
                                </div>
                                <p class="text-muted mb-2">
                                    <small>청구서번호: ${invoice.invoiceNumber || 'N/A'}</small>
                                </p>
                                <p class="mb-2">
                                    <strong>학생:</strong> ${invoice.studentName}<br>
                                    <strong>보호자:</strong> ${invoice.parentName}<br>
                                    <strong>연락처:</strong> ${invoice.parentPhone}
                                </p>
                                <div class="amount mb-3">
                                    ${formatCurrency(invoice.amount)}원
                                </div>
                                <p class="mb-2 small">
                                    <strong>발급일:</strong> ${invoice.issueDate}<br>
                                    <strong>납부기한:</strong> ${invoice.dueDate}
                                    ${invoice.isOverdue ? '<span class="text-danger">(연체)</span>' : ''}
                                </p>
                                ${invoice.description ? `<p class="text-muted small mb-3">${invoice.description}</p>` : ''}
                                ${canPay ? `
                                    <button class="btn btn-primary w-100" onclick="openPaymentModal(${invoice.id})">
                                        결제하기
                                    </button>
                                ` : ''}
                                ${invoice.status === 'PAID' ? `
                                    <div class="alert alert-success mb-0 small">
                                        <strong>납부완료:</strong> ${invoice.paidAt ? invoice.paidAt.replace('T', ' ') : ''}<br>
                                        <strong>결제수단:</strong> ${getPaymentMethodText(invoice.paymentMethod)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
        }

        // 결제 모달 열기
        function openPaymentModal(invoiceId) {
            $.ajax({
                url: '/api/invoices/' + invoiceId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                },
                success: function(invoice) {
                    currentInvoice = invoice;
                    $('#buyerName').val(invoice.parentName || '');
                    $('#buyerTel').val(invoice.parentPhone || '');
                    $('#buyerEmail').val('');
                    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
                    modal.show();
                },
                error: function(xhr) {
                    alert('청구서 조회 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                }
            });
        }

        // 결제 요청
        function requestPayment() {
            if (!currentInvoice) {
                alert('청구서 정보가 없습니다.');
                return;
            }

            const buyerName = $('#buyerName').val();
            const buyerTel = $('#buyerTel').val();
            const buyerEmail = $('#buyerEmail').val();
            const paymentMethod = $('#paymentMethod').val();

            if (!buyerName || !buyerTel) {
                alert('구매자 정보를 입력하세요.');
                return;
            }

            // 1. 결제 준비 API 호출
            $.ajax({
                url: '/api/payments/prepare',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    invoiceId: currentInvoice.id,
                    amount: currentInvoice.amount,
                    buyerName: buyerName,
                    buyerTel: buyerTel,
                    buyerEmail: buyerEmail,
                    paymentMethod: paymentMethod
                }),
                success: function(prepareResponse) {
                    // 모달 닫기
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();

                    // 2. 포트원 결제창 띄우기
                    IMP.request_pay({
                        pg: prepareResponse.pgProvider,
                        pay_method: prepareResponse.paymentMethod,
                        merchant_uid: prepareResponse.merchantUid,
                        name: prepareResponse.name,
                        amount: prepareResponse.amount,
                        buyer_email: prepareResponse.buyerEmail,
                        buyer_name: prepareResponse.buyerName,
                        buyer_tel: prepareResponse.buyerTel
                    }, function(rsp) {
                        if (rsp.success) {
                            // 3. 결제 성공 - 서버 검증
                            verifyPayment(rsp.imp_uid, rsp.merchant_uid);
                        } else {
                            // 결제 실패
                            alert('결제 실패: ' + rsp.error_msg);
                        }
                    });
                },
                error: function(xhr) {
                    alert('결제 준비 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                }
            });
        }

        // 결제 검증
        function verifyPayment(impUid, merchantUid) {
            $.ajax({
                url: '/api/payments/complete',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    impUid: impUid,
                    merchantUid: merchantUid
                }),
                success: function(payment) {
                    alert('결제가 완료되었습니다!\n\n' +
                        '결제금액: ' + formatCurrency(payment.amount) + '원\n' +
                        '결제수단: ' + getPaymentMethodText(payment.paymentMethod));
                    currentInvoice = null;
                    loadInvoices();
                },
                error: function(xhr) {
                    alert('결제 검증 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류') + '\n\n관리자에게 문의하세요.');
                }
            });
        }

        // 유틸리티 함수들
        function getStatusBadge(status) {
            const badges = {
                'PENDING': { class: 'bg-warning text-dark', text: '미납' },
                'PAID': { class: 'bg-success', text: '완납' },
                'OVERDUE': { class: 'bg-danger', text: '연체' },
                'CANCELLED': { class: 'bg-secondary', text: '취소' }
            };
            return badges[status] || { class: 'bg-secondary', text: status };
        }

        function getPaymentMethodText(method) {
            const methods = {
                'card': '신용/체크카드',
                'trans': '실시간 계좌이체',
                'vbank': '가상계좌',
                'phone': '휴대폰 소액결제',
                'kakaopay': '카카오페이',
                'naverpay': '네이버페이',
                'cash': '현금'
            };
            return methods[method] || method;
        }

        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // 페이지 로드 시
        $(document).ready(function() {
            // 저장된 토큰이 있으면 자동 로그인
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                authToken = savedToken;
                $('#loginSection').hide();
                $('#mainSection').show();
                loadInvoices();
            }
        });
    </script>
</body>
</html>
