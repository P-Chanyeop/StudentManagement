<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보강/결석 관리 - K-PLAY 학원</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .request-card {
            border-left: 4px solid;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        .request-card:hover {
            transform: translateX(5px);
        }
        .request-card.pending {
            border-color: #ffc107;
        }
        .request-card.approved {
            border-color: #28a745;
        }
        .request-card.rejected {
            border-color: #dc3545;
        }
        .request-card.completed {
            border-color: #17a2b8;
        }
        .status-filter-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-mortarboard-fill me-2"></i>K-PLAY 학원
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="makeup-class.html">보강/결석관리</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="students.html">학생관리</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> 로그아웃
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-calendar-x text-primary"></i> 보강/결석 관리</h2>
                <p class="text-muted">결석 처리 및 보강 수업 관리</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-danger btn-lg me-2" data-bs-toggle="modal" data-bs-target="#absenceModal">
                    <i class="bi bi-x-circle"></i> 결석 처리
                </button>
                <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#makeupModal">
                    <i class="bi bi-plus-circle"></i> 보강 등록
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-0" id="pendingCount">0</h3>
                        <p class="text-muted mb-0">대기중</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-0" id="approvedCount">0</h3>
                        <p class="text-muted mb-0">승인</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h3 class="text-info mb-0" id="completedCount">0</h3>
                        <p class="text-muted mb-0">보강완료</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <h3 class="text-danger mb-0" id="rejectedCount">0</h3>
                        <p class="text-muted mb-0">거절</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="mb-4">
            <button class="btn btn-outline-warning status-filter-btn active" data-status="all" onclick="filterByStatus('all')">
                전체
            </button>
            <button class="btn btn-outline-warning status-filter-btn" data-status="PENDING" onclick="filterByStatus('PENDING')">
                대기중
            </button>
            <button class="btn btn-outline-success status-filter-btn" data-status="APPROVED" onclick="filterByStatus('APPROVED')">
                승인
            </button>
            <button class="btn btn-outline-info status-filter-btn" data-status="COMPLETED" onclick="filterByStatus('COMPLETED')">
                보강완료
            </button>
            <button class="btn btn-outline-danger status-filter-btn" data-status="REJECTED" onclick="filterByStatus('REJECTED')">
                거절
            </button>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="makeupTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests" type="button">
                    <i class="bi bi-list-ul"></i> 요청 목록
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">
                    <i class="bi bi-calendar"></i> 보강 일정
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">
                    <i class="bi bi-clock-history"></i> 결석 내역
                </button>
            </li>
        </ul>

        <div class="tab-content" id="makeupTabContent">
            <!-- Requests Tab -->
            <div class="tab-pane fade show active" id="requests" role="tabpanel">
                <div id="requestsList">
                    <!-- Requests will be loaded here -->
                </div>
                <div id="emptyRequests" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">요청이 없습니다.</p>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel">
                <div id="scheduleList">
                    <!-- Schedule will be loaded here -->
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="historyStartDate">
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="historyEndDate">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="loadHistory()">
                            <i class="bi bi-search"></i> 검색
                        </button>
                    </div>
                </div>
                <div id="historyList">
                    <!-- History will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Absence Modal -->
    <div class="modal fade" id="absenceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-x-circle"></i> 결석 처리</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="absenceForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">학생 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" id="absenceStudentId" required>
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">수강권 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" id="absenceEnrollmentId" required>
                                <option value="">학생을 먼저 선택하세요</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">결석 날짜 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="absenceDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">사유 <span class="text-danger">*</span></label>
                            <select class="form-select mb-2" id="absenceReasonSelect" onchange="updateAbsenceReason()">
                                <option value="">직접 입력</option>
                                <option value="개인 사정">개인 사정</option>
                                <option value="질병">질병</option>
                                <option value="가족 행사">가족 행사</option>
                                <option value="학교 일정">학교 일정</option>
                                <option value="기타">기타</option>
                            </select>
                            <textarea class="form-control" id="absenceReason" rows="3" placeholder="결석 사유를 입력하세요" required></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requestMakeup" checked>
                                <label class="form-check-label" for="requestMakeup">
                                    보강 수업 신청
                                </label>
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>주의:</strong> 결석 처리 시 수강권 횟수가 1회 차감됩니다.
                            보강 수업 신청 시 승인 후 복구됩니다.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" onclick="processAbsence()">
                        <i class="bi bi-check-circle"></i> 결석 처리
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Makeup Class Modal -->
    <div class="modal fade" id="makeupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> 보강 수업 등록</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="makeupForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">학생 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" id="makeupStudentId" required>
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">수강권 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" id="makeupEnrollmentId" required>
                                <option value="">학생을 먼저 선택하세요</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">보강 날짜 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="makeupDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">시간</label>
                            <input type="time" class="form-control" id="makeupTime">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">사유</label>
                            <textarea class="form-control" id="makeupReason" rows="3" placeholder="보강 사유 (선택)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="createMakeupClass()">
                        <i class="bi bi-check-circle"></i> 등록
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div class="modal fade" id="requestDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> 요청 상세</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="requestDetailContent">
                        <!-- Will be populated dynamically -->
                    </div>
                    <hr>
                    <div id="actionButtons">
                        <!-- Action buttons will be shown based on status -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let allRequests = [];
        let currentRequest = null;
        let currentFilter = 'all';

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Get auth headers
        function getAuthHeaders() {
            return {
                'Authorization': 'Bearer ' + localStorage.getItem('jwtToken'),
                'Content-Type': 'application/json'
            };
        }

        // Logout
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        }

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE_URL}/students`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const students = await response.json();
                    const selects = ['#absenceStudentId', '#makeupStudentId'];
                    selects.forEach(selector => {
                        const select = $(selector);
                        select.empty().append('<option value="">선택하세요</option>');
                        students.filter(s => s.isActive).forEach(student => {
                            select.append(`<option value="${student.id}">${student.name} (${student.grade || '학년미정'})</option>`);
                        });
                    });

                    // Add change event listeners
                    $('#absenceStudentId').on('change', function() {
                        loadStudentEnrollments($(this).val(), '#absenceEnrollmentId');
                    });
                    $('#makeupStudentId').on('change', function() {
                        loadStudentEnrollments($(this).val(), '#makeupEnrollmentId');
                    });
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load student enrollments
        async function loadStudentEnrollments(studentId, targetSelector) {
            const select = $(targetSelector);
            select.empty().append('<option value="">선택하세요</option>');

            if (!studentId) {
                select.append('<option value="">학생을 먼저 선택하세요</option>');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/enrollments/student/${studentId}/active`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const enrollments = await response.json();
                    enrollments.forEach(enrollment => {
                        select.append(`<option value="${enrollment.id}">${enrollment.courseName} (잔여: ${enrollment.remainingCount}회)</option>`);
                    });
                }
            } catch (error) {
                console.error('Error loading enrollments:', error);
            }
        }

        // Load requests
        async function loadRequests() {
            if (!checkAuth()) return;

            try {
                const response = await fetch(`${API_BASE_URL}/makeup-classes/requests`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    allRequests = await response.json();
                } else {
                    // Use sample data
                    allRequests = getSampleRequests();
                }

                updateStatistics();
                filterByStatus(currentFilter);
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = getSampleRequests();
                updateStatistics();
                filterByStatus(currentFilter);
            }
        }

        // Get sample requests
        function getSampleRequests() {
            return [
                {
                    id: 1,
                    studentId: 1,
                    studentName: '김철수',
                    enrollmentId: 1,
                    courseName: '영어 회화 기초',
                    absenceDate: '2024-01-15',
                    makeupDate: null,
                    reason: '개인 사정',
                    status: 'PENDING',
                    requestDate: '2024-01-14'
                },
                {
                    id: 2,
                    studentId: 2,
                    studentName: '이영희',
                    enrollmentId: 2,
                    courseName: '수학 심화',
                    absenceDate: '2024-01-14',
                    makeupDate: '2024-01-20',
                    reason: '질병',
                    status: 'APPROVED',
                    requestDate: '2024-01-13'
                }
            ];
        }

        // Update statistics
        function updateStatistics() {
            const pending = allRequests.filter(r => r.status === 'PENDING').length;
            const approved = allRequests.filter(r => r.status === 'APPROVED').length;
            const completed = allRequests.filter(r => r.status === 'COMPLETED').length;
            const rejected = allRequests.filter(r => r.status === 'REJECTED').length;

            $('#pendingCount').text(pending);
            $('#approvedCount').text(approved);
            $('#completedCount').text(completed);
            $('#rejectedCount').text(rejected);
        }

        // Filter by status
        function filterByStatus(status) {
            currentFilter = status;

            // Update button styles
            $('.status-filter-btn').removeClass('active');
            $(`.status-filter-btn[data-status="${status}"]`).addClass('active');

            let filtered = allRequests;
            if (status !== 'all') {
                filtered = allRequests.filter(r => r.status === status);
            }

            displayRequests(filtered);
        }

        // Display requests
        function displayRequests(requests) {
            const container = $('#requestsList');
            container.empty();

            if (requests.length === 0) {
                $('#emptyRequests').show();
                return;
            }

            $('#emptyRequests').hide();

            requests.forEach(request => {
                const statusInfo = getStatusInfo(request.status);
                const card = $(`
                    <div class="card request-card ${request.status.toLowerCase()}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">${request.studentName}</h5>
                                <span class="badge ${statusInfo.badgeClass}">${statusInfo.text}</span>
                            </div>
                            <p class="mb-1">
                                <i class="bi bi-book"></i> ${request.courseName}
                            </p>
                            <p class="mb-1">
                                <i class="bi bi-calendar-x"></i> 결석일: ${request.absenceDate}
                            </p>
                            ${request.makeupDate ? `<p class="mb-1"><i class="bi bi-calendar-check"></i> 보강일: ${request.makeupDate}</p>` : ''}
                            <p class="mb-2 text-muted">사유: ${request.reason}</p>
                            <small class="text-muted">요청일: ${request.requestDate}</small>
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="viewRequestDetail(${request.id})">
                                <i class="bi bi-eye"></i> 상세
                            </button>
                        </div>
                    </div>
                `);
                container.append(card);
            });
        }

        // Get status info
        function getStatusInfo(status) {
            const statusMap = {
                'PENDING': { text: '대기중', badgeClass: 'bg-warning' },
                'APPROVED': { text: '승인', badgeClass: 'bg-success' },
                'REJECTED': { text: '거절', badgeClass: 'bg-danger' },
                'COMPLETED': { text: '보강완료', badgeClass: 'bg-info' }
            };
            return statusMap[status] || { text: status, badgeClass: 'bg-secondary' };
        }

        // View request detail
        function viewRequestDetail(requestId) {
            currentRequest = allRequests.find(r => r.id === requestId);
            if (!currentRequest) {
                alert('요청을 찾을 수 없습니다.');
                return;
            }

            const statusInfo = getStatusInfo(currentRequest.status);
            const html = `
                <table class="table">
                    <tr>
                        <th>학생</th>
                        <td>${currentRequest.studentName}</td>
                    </tr>
                    <tr>
                        <th>과정</th>
                        <td>${currentRequest.courseName}</td>
                    </tr>
                    <tr>
                        <th>결석일</th>
                        <td>${currentRequest.absenceDate}</td>
                    </tr>
                    ${currentRequest.makeupDate ? `<tr><th>보강일</th><td>${currentRequest.makeupDate}</td></tr>` : ''}
                    <tr>
                        <th>사유</th>
                        <td>${currentRequest.reason}</td>
                    </tr>
                    <tr>
                        <th>상태</th>
                        <td><span class="badge ${statusInfo.badgeClass}">${statusInfo.text}</span></td>
                    </tr>
                    <tr>
                        <th>요청일</th>
                        <td>${currentRequest.requestDate}</td>
                    </tr>
                </table>
            `;

            $('#requestDetailContent').html(html);

            // Show action buttons based on status
            let actionButtons = '';
            if (currentRequest.status === 'PENDING') {
                actionButtons = `
                    <button class="btn btn-success" onclick="approveRequest()">
                        <i class="bi bi-check-circle"></i> 승인
                    </button>
                    <button class="btn btn-danger ms-2" onclick="rejectRequest()">
                        <i class="bi bi-x-circle"></i> 거절
                    </button>
                `;
            } else if (currentRequest.status === 'APPROVED') {
                actionButtons = `
                    <button class="btn btn-info" onclick="completeMakeup()">
                        <i class="bi bi-check-circle"></i> 보강 완료
                    </button>
                `;
            }

            $('#actionButtons').html(actionButtons);
            $('#requestDetailModal').modal('show');
        }

        // Update absence reason
        function updateAbsenceReason() {
            const selected = $('#absenceReasonSelect').val();
            if (selected) {
                $('#absenceReason').val(selected);
            }
        }

        // Process absence
        async function processAbsence() {
            const absenceData = {
                studentId: parseInt($('#absenceStudentId').val()),
                enrollmentId: parseInt($('#absenceEnrollmentId').val()),
                absenceDate: $('#absenceDate').val(),
                reason: $('#absenceReason').val(),
                requestMakeup: $('#requestMakeup').is(':checked')
            };

            if (!absenceData.studentId || !absenceData.enrollmentId || !absenceData.absenceDate || !absenceData.reason) {
                alert('필수 항목을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/makeup-classes/absence`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(absenceData)
                });

                if (!response.ok) throw new Error('Failed to process absence');

                alert('결석 처리가 완료되었습니다.');
                $('#absenceModal').modal('hide');
                $('#absenceForm')[0].reset();
                loadRequests();
            } catch (error) {
                console.error('Error processing absence:', error);
                alert('결석 처리에 실패했습니다.');
            }
        }

        // Create makeup class
        async function createMakeupClass() {
            const makeupData = {
                studentId: parseInt($('#makeupStudentId').val()),
                enrollmentId: parseInt($('#makeupEnrollmentId').val()),
                makeupDate: $('#makeupDate').val(),
                makeupTime: $('#makeupTime').val() || null,
                reason: $('#makeupReason').val() || null
            };

            if (!makeupData.studentId || !makeupData.enrollmentId || !makeupData.makeupDate) {
                alert('필수 항목을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/makeup-classes`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(makeupData)
                });

                if (!response.ok) throw new Error('Failed to create makeup class');

                alert('보강 수업이 등록되었습니다.');
                $('#makeupModal').modal('hide');
                $('#makeupForm')[0].reset();
                loadRequests();
            } catch (error) {
                console.error('Error creating makeup class:', error);
                alert('보강 수업 등록에 실패했습니다.');
            }
        }

        // Approve request
        async function approveRequest() {
            if (!currentRequest) return;

            const makeupDate = prompt('보강 날짜를 입력하세요 (YYYY-MM-DD):');
            if (!makeupDate) return;

            try {
                const response = await fetch(`${API_BASE_URL}/makeup-classes/${currentRequest.id}/approve`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ makeupDate })
                });

                if (!response.ok) throw new Error('Failed to approve request');

                alert('보강 요청이 승인되었습니다.');
                $('#requestDetailModal').modal('hide');
                loadRequests();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('승인에 실패했습니다.');
            }
        }

        // Reject request
        async function rejectRequest() {
            if (!currentRequest) return;

            if (!confirm('정말 이 요청을 거절하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/makeup-classes/${currentRequest.id}/reject`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to reject request');

                alert('보강 요청이 거절되었습니다.');
                $('#requestDetailModal').modal('hide');
                loadRequests();
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('거절에 실패했습니다.');
            }
        }

        // Complete makeup
        async function completeMakeup() {
            if (!currentRequest) return;

            if (!confirm('보강 수업을 완료 처리하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/makeup-classes/${currentRequest.id}/complete`, {
                    method: 'PATCH',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to complete makeup');

                alert('보강 수업이 완료되었습니다.');
                $('#requestDetailModal').modal('hide');
                loadRequests();
            } catch (error) {
                console.error('Error completing makeup:', error);
                alert('완료 처리에 실패했습니다.');
            }
        }

        // Initialize
        $(document).ready(function() {
            checkAuth();
            loadStudents();
            loadRequests();

            // Set default dates
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            $('#historyStartDate').val(lastMonth.toISOString().split('T')[0]);
            $('#historyEndDate').val(today.toISOString().split('T')[0]);
            $('#absenceDate').val(today.toISOString().split('T')[0]);
            $('#makeupDate').val(today.toISOString().split('T')[0]);

            // Auto refresh every 5 minutes
            setInterval(loadRequests, 300000);
        });
    </script>
</body>
</html>
