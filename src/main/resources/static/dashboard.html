<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - K-PLAY í•™ì›</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            padding-top: 20px;
        }

        .top-nav {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 1.1rem;
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            text-decoration: none;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            color: white;
        }

        .action-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .action-btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .action-btn-info {
            background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
        }

        .action-btn-warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }

        .action-btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .alert-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid;
            margin-bottom: 15px;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .alert-warning {
            border-color: #f0ad4e;
        }

        .alert-danger {
            border-color: #d9534f;
        }

        .alert-info {
            border-color: #5bc0de;
        }
    </style>
</head>
<body>
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                    <p class="mb-0 text-muted" id="currentDate"></p>
                </div>
                <div>
                    <a href="index.html" class="btn btn-outline-secondary me-2">í™ˆ</a>
                    <button class="btn btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¨â€ğŸ“</div>
                <div class="stat-label">ì „ì²´ í•™ìƒ</div>
                <div class="stat-number text-primary" id="totalStudents">0</div>
                <div class="stat-change text-success">í™œì„± ìˆ˜ê°•ê¶Œ: <span id="activeEnrollments">0</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì¶œì„</div>
                <div class="stat-number text-success" id="todayAttendance">0</div>
                <div class="stat-change text-muted">ì§€ê°: <span id="todayLate">0</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-label">ì˜¤ëŠ˜ ì˜ˆì•½</div>
                <div class="stat-number text-info" id="todayReservations">0</div>
                <div class="stat-change text-muted">í™•ì •: <span id="confirmedReservations">0</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
                <div class="stat-number text-warning" id="monthlyRevenue">0ì›</div>
                <div class="stat-change text-success">ë¯¸ìˆ˜ê¸ˆ: <span id="unpaidAmount">0ì›</span></div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="section-title">âš¡ ë¹ ë¥¸ ì‹¤í–‰</div>
            <div class="action-grid">
                <a href="attendance.html" class="action-btn action-btn-primary">
                    ğŸ“‹ ì¶œì„ ì²´í¬
                </a>
                <a href="students.html" class="action-btn action-btn-success">
                    ğŸ‘¨â€ğŸ“ í•™ìƒ ê´€ë¦¬
                </a>
                <a href="enrollments.html" class="action-btn action-btn-info">
                    ğŸ“š ìˆ˜ê°•ê¶Œ ê´€ë¦¬
                </a>
                <a href="reservations.html" class="action-btn action-btn-warning">
                    ğŸ“… ì˜ˆì•½ ê´€ë¦¬
                </a>
                <a href="admin-invoices.html" class="action-btn action-btn-danger">
                    ğŸ’³ ì²­êµ¬ì„œ ê´€ë¦¬
                </a>
                <a href="sms.html" class="action-btn action-btn-info">
                    ğŸ“¨ ë¬¸ì ë°œì†¡
                </a>
                <a href="leveltest-calendar.html" class="action-btn action-btn-success">
                    ğŸ“Š ë ˆë²¨í…ŒìŠ¤íŠ¸
                </a>
                <a href="makeup-class.html" class="action-btn action-btn-warning">
                    ğŸ”„ ë³´ê°• ê´€ë¦¬
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Charts -->
            <div class="col-lg-8">
                <div class="chart-section">
                    <div class="section-title">ğŸ“ˆ ì£¼ê°„ ì¶œì„ í˜„í™©</div>
                    <canvas id="weeklyAttendanceChart"></canvas>
                </div>

                <div class="chart-section">
                    <div class="section-title">ğŸ’° ì›”ë³„ ë§¤ì¶œ í˜„í™©</div>
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
            </div>

            <!-- Alerts and Notifications -->
            <div class="col-lg-4">
                <div class="alert-section">
                    <div class="section-title">ğŸ”” ì•Œë¦¼</div>
                    <div id="alertsList">
                        <div class="alert-item alert-warning">
                            <strong>âš ï¸ ë§Œë£Œ ì„ë°•</strong>
                            <p class="mb-0 mt-2">ìˆ˜ê°•ê¶Œ ë§Œë£Œ 4ì£¼ ì´ë‚´: <span id="expiringCount">0</span>ëª…</p>
                        </div>
                        <div class="alert-item alert-danger">
                            <strong>ğŸ”´ ì—°ì²´</strong>
                            <p class="mb-0 mt-2">ì—°ì²´ ì²­êµ¬ì„œ: <span id="overdueCount">0</span>ê±´</p>
                        </div>
                        <div class="alert-item alert-info">
                            <strong>ğŸ“… ë ˆë²¨í…ŒìŠ¤íŠ¸</strong>
                            <p class="mb-0 mt-2">ì˜ˆì •ëœ í…ŒìŠ¤íŠ¸: <span id="upcomingTestsCount">0</span>ê±´</p>
                        </div>
                        <div class="alert-item alert-warning">
                            <strong>ğŸ“‰ íšŸìˆ˜ ë¶€ì¡±</strong>
                            <p class="mb-0 mt-2">ë‚¨ì€ íšŸìˆ˜ 3íšŒ ì´í•˜: <span id="lowCountCount">0</span>ëª…</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let authToken = '';
        let weeklyChart, monthlyChart;

        $(document).ready(function() {
            authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'admin-invoices.html';
                return;
            }

            updateCurrentDate();
            loadDashboardData();
            setInterval(loadDashboardData, 60000); // 1ë¶„ë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
        });

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            };
            $('#currentDate').text(now.toLocaleDateString('ko-KR', options));
        }

        function loadDashboardData() {
            loadStudentStats();
            loadAttendanceStats();
            loadReservationStats();
            loadInvoiceStats();
            loadEnrollmentStats();
            loadLevelTestStats();
            loadCharts();
        }

        function loadStudentStats() {
            $.ajax({
                url: '/api/students',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(students) {
                    $('#totalStudents').text(students.length);
                },
                error: handleError
            });
        }

        function loadAttendanceStats() {
            const today = new Date().toISOString().split('T')[0];
            $.ajax({
                url: '/api/attendances/date/' + today,
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(attendances) {
                    $('#todayAttendance').text(attendances.length);
                    const late = attendances.filter(a => a.status === 'LATE').length;
                    $('#todayLate').text(late);
                },
                error: function() {
                    $('#todayAttendance').text('0');
                    $('#todayLate').text('0');
                }
            });
        }

        function loadReservationStats() {
            const today = new Date().toISOString().split('T')[0];
            $.ajax({
                url: '/api/reservations/date/' + today,
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(reservations) {
                    $('#todayReservations').text(reservations.length);
                    const confirmed = reservations.filter(r => r.status === 'CONFIRMED').length;
                    $('#confirmedReservations').text(confirmed);
                },
                error: function() {
                    $('#todayReservations').text('0');
                    $('#confirmedReservations').text('0');
                }
            });
        }

        function loadInvoiceStats() {
            $.ajax({
                url: '/api/invoices/statistics',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(stats) {
                    $('#monthlyRevenue').text(formatCurrency(stats.paidAmount) + 'ì›');
                    $('#unpaidAmount').text(formatCurrency(stats.unpaidAmount) + 'ì›');
                    $('#overdueCount').text(stats.overdueCount);
                },
                error: function() {
                    $('#monthlyRevenue').text('0ì›');
                    $('#unpaidAmount').text('0ì›');
                }
            });
        }

        function loadEnrollmentStats() {
            $.ajax({
                url: '/api/enrollments',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(enrollments) {
                    const active = enrollments.filter(e => e.isActive).length;
                    $('#activeEnrollments').text(active);
                },
                error: function() {
                    $('#activeEnrollments').text('0');
                }
            });

            $.ajax({
                url: '/api/enrollments/expiring?days=28',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(enrollments) {
                    $('#expiringCount').text(enrollments.length);
                }
            });

            $.ajax({
                url: '/api/enrollments/low-count?threshold=3',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(enrollments) {
                    $('#lowCountCount').text(enrollments.length);
                }
            });
        }

        function loadLevelTestStats() {
            $.ajax({
                url: '/api/leveltests/upcoming',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(tests) {
                    $('#upcomingTestsCount').text(tests.length);
                },
                error: function() {
                    $('#upcomingTestsCount').text('0');
                }
            });
        }

        function loadCharts() {
            // ì£¼ê°„ ì¶œì„ ì°¨íŠ¸
            const weeklyCtx = document.getElementById('weeklyAttendanceChart').getContext('2d');
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                    datasets: [{
                        label: 'ì¶œì„',
                        data: [12, 19, 15, 17, 14, 20, 18],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            // ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸
            const monthlyCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”'],
                    datasets: [{
                        label: 'ë§¤ì¶œ (ë§Œì›)',
                        data: [120, 150, 180, 170, 200, 190],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function handleError(xhr) {
            if (xhr.status === 401) {
                alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                logout();
            }
        }
    </script>
</body>
</html>
