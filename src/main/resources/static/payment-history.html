<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 내역 - K-PLAY 학원</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .container {
            max-width: 1400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>결제 내역</h2>
            <div>
                <a href="admin-invoices.html" class="btn btn-secondary me-2">청구서 관리</a>
                <button class="btn btn-secondary" onclick="logout()">로그아웃</button>
            </div>
        </div>

        <!-- 필터 -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">결제 상태</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">전체</option>
                            <option value="PAID">결제완료</option>
                            <option value="CANCELLED">취소</option>
                            <option value="REFUNDED">환불</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadPayments()">조회</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결제 내역 테이블 -->
        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>결제번호</th>
                            <th>청구서</th>
                            <th>학생명</th>
                            <th>결제금액</th>
                            <th>결제수단</th>
                            <th>PG사</th>
                            <th>결제일시</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="paymentTableBody">
                        <!-- 동적으로 채워짐 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 결제 상세 모달 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">결제 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">
                    <!-- 동적으로 채워짐 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 결제 취소 모달 -->
    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">결제 취소</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">취소 사유</label>
                        <textarea class="form-control" id="cancelReason" rows="3" placeholder="취소 사유를 입력하세요"></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <strong>주의:</strong> 결제를 취소하면 청구서도 함께 취소됩니다.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-danger" onclick="cancelPayment()">취소하기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let authToken = '';
        let currentPayment = null;

        function logout() {
            authToken = '';
            localStorage.removeItem('authToken');
            window.location.href = 'admin-invoices.html';
        }

        function loadPayments() {
            $.ajax({
                url: '/api/payments',
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(payments) {
                    displayPayments(payments);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        alert('인증이 만료되었습니다.');
                        logout();
                    }
                }
            });
        }

        function displayPayments(payments) {
            const tbody = $('#paymentTableBody');
            tbody.empty();

            if (payments.length === 0) {
                tbody.html('<tr><td colspan="9" class="text-center">결제 내역이 없습니다.</td></tr>');
                return;
            }

            payments.forEach(payment => {
                const statusBadge = getStatusBadge(payment.status);
                const row = `
                    <tr>
                        <td>${payment.impUid.substring(0, 15)}...</td>
                        <td>${payment.invoiceNumber}</td>
                        <td>-</td>
                        <td>${formatCurrency(payment.amount)}원</td>
                        <td>${getPaymentMethodText(payment.paymentMethod)}</td>
                        <td>${payment.pgProvider || '-'}</td>
                        <td>${payment.paidAt ? formatDateTime(payment.paidAt) : '-'}</td>
                        <td><span class="badge ${statusBadge.class}">${statusBadge.text}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showDetail('${payment.impUid}')">상세</button>
                            ${payment.status === 'PAID' ?
                                `<button class="btn btn-sm btn-danger" onclick="openCancelModal('${payment.impUid}')">취소</button>` : ''}
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function showDetail(impUid) {
            $.ajax({
                url: '/api/payments/imp/' + impUid,
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(payment) {
                    const content = `
                        <table class="table">
                            <tr><th>포트원 결제번호</th><td>${payment.impUid}</td></tr>
                            <tr><th>주문번호</th><td>${payment.merchantUid}</td></tr>
                            <tr><th>청구서번호</th><td>${payment.invoiceNumber}</td></tr>
                            <tr><th>결제금액</th><td>${formatCurrency(payment.amount)}원</td></tr>
                            <tr><th>결제수단</th><td>${getPaymentMethodText(payment.paymentMethod)}</td></tr>
                            <tr><th>PG사</th><td>${payment.pgProvider || '-'}</td></tr>
                            <tr><th>결제상태</th><td><span class="badge ${getStatusBadge(payment.status).class}">${getStatusBadge(payment.status).text}</span></td></tr>
                            <tr><th>결제일시</th><td>${payment.paidAt ? formatDateTime(payment.paidAt) : '-'}</td></tr>
                            <tr><th>구매자명</th><td>${payment.buyerName || '-'}</td></tr>
                            <tr><th>구매자 연락처</th><td>${payment.buyerTel || '-'}</td></tr>
                            <tr><th>구매자 이메일</th><td>${payment.buyerEmail || '-'}</td></tr>
                            ${payment.cardName ? `<tr><th>카드사</th><td>${payment.cardName}</td></tr>` : ''}
                            ${payment.cardNumber ? `<tr><th>카드번호</th><td>${payment.cardNumber}</td></tr>` : ''}
                            ${payment.vbankName ? `<tr><th>가상계좌 은행</th><td>${payment.vbankName}</td></tr>` : ''}
                            ${payment.vbankNum ? `<tr><th>가상계좌 번호</th><td>${payment.vbankNum}</td></tr>` : ''}
                            ${payment.receiptUrl ? `<tr><th>영수증</th><td><a href="${payment.receiptUrl}" target="_blank">보기</a></td></tr>` : ''}
                        </table>
                    `;
                    $('#detailContent').html(content);
                    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                    modal.show();
                }
            });
        }

        function openCancelModal(impUid) {
            $.ajax({
                url: '/api/payments/imp/' + impUid,
                type: 'GET',
                headers: { 'Authorization': 'Bearer ' + authToken },
                success: function(payment) {
                    currentPayment = payment;
                    $('#cancelReason').val('');
                    const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
                    modal.show();
                }
            });
        }

        function cancelPayment() {
            if (!currentPayment) return;

            const reason = $('#cancelReason').val();
            if (!reason) {
                alert('취소 사유를 입력하세요.');
                return;
            }

            $.ajax({
                url: '/api/payments/cancel',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    impUid: currentPayment.impUid,
                    reason: reason
                }),
                success: function() {
                    alert('결제가 취소되었습니다.');
                    bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
                    loadPayments();
                    currentPayment = null;
                },
                error: function(xhr) {
                    alert('취소 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                }
            });
        }

        function getStatusBadge(status) {
            const badges = {
                'PENDING': { class: 'bg-secondary', text: '대기' },
                'READY': { class: 'bg-info', text: '준비' },
                'PAID': { class: 'bg-success', text: '완료' },
                'FAILED': { class: 'bg-danger', text: '실패' },
                'CANCELLED': { class: 'bg-warning text-dark', text: '취소' },
                'REFUNDED': { class: 'bg-secondary', text: '환불' },
                'PARTIAL_REFUNDED': { class: 'bg-warning text-dark', text: '부분환불' }
            };
            return badges[status] || { class: 'bg-secondary', text: status };
        }

        function getPaymentMethodText(method) {
            const methods = {
                'card': '신용/체크카드',
                'trans': '실시간 계좌이체',
                'vbank': '가상계좌',
                'phone': '휴대폰 소액결제',
                'kakaopay': '카카오페이',
                'naverpay': '네이버페이'
            };
            return methods[method] || method;
        }

        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatDateTime(dateTime) {
            return dateTime.replace('T', ' ').substring(0, 19);
        }

        $(document).ready(function() {
            authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('로그인이 필요합니다.');
                window.location.href = 'admin-invoices.html';
                return;
            }
            loadPayments();
        });
    </script>
</body>
</html>
